name: PR PDF Comment

on:
  workflow_run:
    workflows: ["PR PDF Preview"]
    types: [completed]

jobs:
  notify:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read

    steps:
      - name: Announce PDF artifact on PR
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run
            const pr = run.pull_requests && run.pull_requests[0]

            if (!pr) {
              core.warning('No pull request associated with the workflow run; skipping comment.')
              return
            }

            const owner = context.repo.owner
            const repo = context.repo.repo
            const runId = run.id
            const shortSha = run.head_sha.substring(0, 7)
            const workflowUrl = run.html_url || `${context.payload.repository.html_url}/actions/runs/${runId}`
            const expectedName = `pr-${pr.number}-preview`
            const marker = `<!-- pdf-preview-bot pr-${pr.number} -->`

            const artifactsResponse = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: runId,
            })

            const artifact = artifactsResponse.data.artifacts.find(a => a.name === expectedName)

            if (!artifact) {
              core.warning(`Artifact ${expectedName} not found on run ${runId}; skipping comment.`)
              return
            }

            const body = `${marker}
            ðŸ“„ **PDF Preview available**

            Latest build ran on commit \`${shortSha}\`.

            **ðŸ“¥ To download the PDF:**
            1. [Open the workflow run](${workflowUrl})
            2. Go to the **Artifacts** section
            3. Download \`${expectedName}\`

            The artifact is available for 30 days.`

            const existingComments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: pr.number,
            })

            const existing = existingComments.data.find(c => c.body && c.body.includes(marker))

            if (existing) {
              try {
                await github.rest.issues.deleteComment({
                  owner,
                  repo,
                  comment_id: existing.id,
                })
                core.info(`Deleted previous comment on PR #${pr.number}`)
              } catch (e) {
                core.warning(`Could not delete previous comment: ${e.message}`)
              }
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr.number,
              body,
            })
            core.info(`Created new comment on PR #${pr.number}`)
